{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://talos.security/schemas/audit/audit_event.schema.json",
  "title": "Talos Audit Event",
  "description": "Canonical Audit Event Structure",
  "type": "object",
  "required": [
    "schema_id", "schema_version", "event_id", "ts", "request_id", 
    "surface_id", "action", "status", "principal", "data_classification", "event_hash"
  ],
  "properties": {
    "schema_id": { "const": "talos.audit_event" },
    "schema_version": { "const": "v1" },
    "event_id": { "type": "string", "format": "uuid" },
    "ts": { "type": "string", "format": "date-time", "description": "ISO8601 UTC" },
    "request_id": { "type": "string" },
    "correlation_id": { "type": "string" },
    
    "surface_id": { "type": "string", "description": "Opcode from Inventory" },
    "action": { "type": "string", "description": "Audit Action from Inventory" },
    "status": { "type": "string", "enum": ["success", "failure", "denied"] },
    
    "http": {
      "type": "object",
      "required": ["method", "path", "status_code"],
      "properties": {
        "method": { "type": "string" },
        "path": { "type": "string" },
        "status_code": { "type": "integer" },
        "client_ip_hash": { "type": "string" }
      }
    },
    
    "principal": {
      "type": "object",
      "required": ["principal_id", "team_id", "auth_mode"],
      "properties": {
        "principal_id": { "type": "string" },
        "team_id": { "type": "string" },
        "org_id": { "type": "string" },
        "auth_mode": { "type": "string", "enum": ["bearer", "attested", "bearer_attested"] },
        "signer_key_id": { "type": "string" }
      }
    },
    
    "resource": {
      "type": "object",
      "properties": {
        "resource_type": { "type": "string" },
        "resource_id": { "type": "string" },
        "resource_ref": { "type": "string" }
      }
    },
    
    "meta": {
      "type": "object",
      "description": "Strictly allowlisted metadata"
    },
    
    "data_classification": { "type": "string", "enum": ["public", "metadata", "sensitive"] },
    
    "event_hash": {
      "type": "string",
      "description": "SHA256 hash of canonical JSON of event (excluding event_hash)"
    },
    "prev_event_hash": {
      "type": "string",
      "description": "Hash of previous event in stream (optional in Gateway, mandatory in Audit Service)"
    }
  },
  "additionalProperties": false
}
