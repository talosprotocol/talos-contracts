{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://talosprotocol.com/schemas/mcp/tool_registry.schema.json",
  "title": "MCP Tool Registry (LOCKED)",
  "description": "Source of truth for tool classification and document handling rules. Manifest-first, deny-by-default enforcement.",
  "type": "object",
  "required": ["schema_id", "schema_version", "server_id", "server_version", "tools"],
  "properties": {
    "schema_id": {
      "const": "talos.mcp.tool_registry",
      "description": "Schema identifier"
    },
    "schema_version": {
      "const": "v1",
      "description": "Schema version"
    },
    "server_id": {
      "type": "string",
      "pattern": "^[a-z0-9-]+$",
      "description": "MCP server identifier (lowercase, hyphens allowed)"
    },
    "server_version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "description": "Semantic version of the server"
    },
    "tools": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/tool_definition"
      },
      "minItems": 1,
      "description": "List of tools provided by this server"
    }
  },
  "additionalProperties": false,
  "$defs": {
    "tool_definition": {
      "type": "object",
      "required": ["tool_name", "tool_class", "is_document_op"],
      "properties": {
        "tool_name": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "description": "Exact tool name (lowercase, hyphens allowed)"
        },
        "tool_class": {
          "type": "string",
          "enum": ["read", "write"],
          "description": "Classification: read (immutable) or write (mutation)"
        },
        "is_document_op": {
          "type": "boolean",
          "description": "Whether this tool handles document content"
        },
        "requires_idempotency_key": {
          "type": "boolean",
          "default": false,
          "description": "If true, connector and gateway must enforce idempotency_key presence"
        },
        "document_spec": {
          "type": "object",
          "properties": {
            "write_content_pointers": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^/",
                "description": "JSON Pointer (RFC 6901) to document content in args"
              },
              "description": "Pointers to extract write content from request args (pre-execution)"
            },
            "read_content_pointers": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^/",
                "description": "JSON Pointer (RFC 6901) to document content in tool result"
              },
              "description": "Pointers to extract read content from tool response (post-execution)"
            },
            "content_encoding": {
              "type": "string",
              "enum": ["utf8", "base64"],
              "description": "Encoding of document content"
            },
            "max_read_bytes": {
              "type": "integer",
              "minimum": 1,
              "maximum": 10485760,
              "default": 10485760,
              "description": "Maximum bytes for single read operation (default: 10MB)"
            },
            "max_write_bytes": {
              "type": "integer",
              "minimum": 1,
              "maximum": 5242880,
              "default": 5242880,
              "description": "Maximum bytes for single write operation (default: 5MB)"
            },
            "max_batch_bytes": {
              "type": "integer",
              "minimum": 1,
              "maximum": 52428800,
              "default": 52428800,
              "description": "Maximum total bytes for batch operations (default: 50MB)"
            }
          },
          "required": ["content_encoding", "max_read_bytes", "max_write_bytes", "max_batch_bytes"],
          "additionalProperties": false,
          "if": {
            "properties": {
              "write_content_pointers": {
                "minItems": 1
              }
            }
          },
          "then": {
            "description": "Write document operations must have write_content_pointers"
          },
          "else": {
            "if": {
              "properties": {
                "read_content_pointers": {
                  "minItems": 1
                }
              }
            },
            "then": {
              "description": "Read document operations must have read_content_pointers"
            }
          }
        }
      },
      "additionalProperties": false,
      "if": {
        "properties": {
          "is_document_op": {
            "const": true
          }
        }
      },
      "then": {
        "required": ["document_spec"],
        "properties": {
          "document_spec": {
            "anyOf": [
              {
                "required": ["write_content_pointers"]
              },
              {
                "required": ["read_content_pointers"]
              }
            ]
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "tool_class": {
                "const": "write"
              }
            }
          },
          "then": {
            "properties": {
              "requires_idempotency_key": {
                "const": true
              }
            }
          }
        }
      ]
    }
  }
}
