#!/usr/bin/env bash
set -euo pipefail

echo "üöÄ Running pre-push validation..."

if [ -d "typescript" ]; then
    echo "üî∑ TypeScript pre-push checks"
    
    # Verify versions match
    echo "  ‚ñ∏ Verifying version consistency..."
    node scripts/verify-versions.mjs

    cd typescript
    
    # Full validation before push
    npm run validate
    
    # Consumer smoke test
    echo "  ‚ñ∏ Running consumer smoke test..."
    npm run smoke:pack
    
    echo "‚úÖ TypeScript pre-push passed"
    cd ..
fi

if [ -d "python" ]; then
    echo "üêç Python pre-push checks"
    cd python
    
    # Full test suite with coverage
    echo "  ‚ñ∏ Running full test suite..."
    pytest -v --tb=short
    
    # Strict mypy
    echo "  ‚ñ∏ Strict type checking..."
    mypy talos_contracts/ --ignore-missing-imports
    
    # Build validation
    echo "  ‚ñ∏ Building distribution..."
    python -m build --sdist --wheel --outdir dist/
    
    # Verify py.typed in wheel
    echo "  ‚ñ∏ Verifying py.typed in wheel..."
    if python3 -c "import zipfile, sys, glob; wheel = glob.glob('dist/*.whl')[0]; sys.exit(0 if 'talos_contracts/py.typed' in zipfile.ZipFile(wheel).namelist() else 1)"; then
         echo "    ‚úì py.typed verified in wheel"
    else
        echo "‚ùå py.typed not found in wheel!"
        exit 1
    fi
    
    # Cleanup
    rm -rf dist/
    
    echo "‚úÖ Python pre-push passed"
    cd ..
fi

echo ""
echo "üéâ All pre-push checks passed!"
