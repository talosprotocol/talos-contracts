#!/usr/bin/env bash
set -euo pipefail

echo "ğŸš€ Running pre-push validation..."

if [ -d "typescript" ]; then
    echo "ğŸ”· TypeScript pre-push checks"
    cd typescript
    
    # Full validation before push
    npm run validate
    
    # Consumer smoke test
    echo "  â–¸ Running consumer smoke test..."
    npm run smoke:pack
    
    echo "âœ… TypeScript pre-push passed"
    cd ..
fi

if [ -d "python" ]; then
    echo "ğŸ Python pre-push checks"
    cd python
    
    # Full test suite with coverage
    echo "  â–¸ Running full test suite..."
    pytest -v --tb=short
    
    # Strict mypy
    echo "  â–¸ Strict type checking..."
    mypy talos_contracts/ --ignore-missing-imports
    
    # Build validation
    echo "  â–¸ Building distribution..."
    python -m build --sdist --wheel --outdir dist/
    
    # Verify py.typed in wheel
    echo "  â–¸ Verifying py.typed in wheel..."
    if python3 -c "import zipfile, sys, glob; wheel = glob.glob('dist/*.whl')[0]; sys.exit(0 if 'talos_contracts/py.typed' in zipfile.ZipFile(wheel).namelist() else 1)"; then
         echo "    âœ“ py.typed verified in wheel"
    else
        echo "âŒ py.typed not found in wheel!"
        exit 1
    fi
    
    # Cleanup
    rm -rf dist/
    
    echo "âœ… Python pre-push passed"
    cd ..
fi

echo ""
echo "ğŸ‰ All pre-push checks passed!"
