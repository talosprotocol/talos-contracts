#!/usr/bin/env bash
set -euo pipefail

# TypeScript
if [ -d "typescript" ]; then
    echo "ðŸ”· TypeScript pre-commit checks"
    cd typescript
    
    # Sync version
    node scripts/version-sync.mjs
    git add package.json
    
    if [ -f pnpm-lock.yaml ]; then
      git add pnpm-lock.yaml
    fi
    if [ -f package-lock.json ]; then
      git add package-lock.json
    fi
    
    # Run lint-staged (handles lint + format for staged files)
    echo "  â–¸ Linting staged files..."
    npx lint-staged
    
    # Type check
    echo "  â–¸ Type checking..."
    npm run typecheck
    
    # Build check (ensures the build doesn't break)
    echo "  â–¸ Building..."
    npm run build
    
    # Run tests
    echo "  â–¸ Running tests..."
    npm run test
    
    # Package validation (ensures exports are correct)
    echo "  â–¸ Validating package..."
    npm pack --dry-run > /dev/null 2>&1
    
    echo "âœ… TypeScript checks passed"
    cd ..
fi

# Python
if [ -d "python" ]; then
    echo "ðŸ Python pre-commit checks"
    cd python
    
    # Lint if ruff available
    if command -v ruff &> /dev/null; then
        echo "  â–¸ Linting..."
        ruff check .
    fi
    
    # Run tests
    echo "  â–¸ Running tests..."
    pytest -v
    
    echo "âœ… Python checks passed"
    cd ..
fi

echo ""
echo "ðŸŽ‰ All pre-commit checks passed!"
