#!/usr/bin/env bash
set -euo pipefail

# TypeScript
if [ -d "typescript" ]; then
    echo "ðŸ”· TypeScript pre-commit checks"
    
    # Verify versions match before proceeding
    echo "  â–¸ Verifying version consistency..."
    node scripts/verify-versions.mjs
    
    cd typescript
    
    # Sync version
    node scripts/version-sync.mjs
    git add package.json
    
    if [ -f pnpm-lock.yaml ]; then
      git add pnpm-lock.yaml
    fi
    if [ -f package-lock.json ]; then
      git add package-lock.json
    fi
    
    # Run lint-staged (handles lint + format for staged files)
    echo "  â–¸ Linting staged files..."
    npx lint-staged
    
    # Type check
    echo "  â–¸ Type checking..."
    npm run typecheck
    
    # Build check (ensures the build doesn't break)
    echo "  â–¸ Building..."
    npm run build
    
    # Run tests
    echo "  â–¸ Running tests..."
    npm run test
    
    # Package validation (ensures exports are correct)
    echo "  â–¸ Validating package..."
    npm pack --dry-run > /dev/null 2>&1
    
    echo "âœ… TypeScript checks passed"
    cd ..
fi

# Python
if [ -d "python" ]; then
    echo "ðŸ Python pre-commit checks"
    cd python
    
    # Ensure dev dependencies are installed
    if ! pip show ruff &> /dev/null; then
        echo "  â–¸ Installing dev dependencies..."
        pip install -e ".[dev]" -q
    fi
    
    # Lint with ruff
    echo "  â–¸ Linting with ruff..."
    ruff check talos_contracts/ tests/ --fix
    
    # Format with ruff
    echo "  â–¸ Formatting with ruff..."
    ruff format talos_contracts/ tests/
    
    # Type check with mypy (if strict mode)
    echo "  â–¸ Type checking with mypy..."
    mypy talos_contracts/ --ignore-missing-imports || echo "    âš  mypy warnings (non-blocking)"
    
    # Run tests
    echo "  â–¸ Running tests..."
    pytest -v --tb=short
    
    # Package validation
    echo "  â–¸ Validating package can build..."
    rm -rf /tmp/python-build-check
    python -m build --sdist --wheel --outdir /tmp/python-build-check > /dev/null 2>&1
    
    # Verify py.typed is in wheel
    echo "  â–¸ Checking py.typed in wheel..."
    if python3 -c "import zipfile, sys, glob; wheel = glob.glob('/tmp/python-build-check/*.whl')[0]; sys.exit(0 if 'talos_contracts/py.typed' in zipfile.ZipFile(wheel).namelist() else 1)"; then
        echo "    âœ“ py.typed found in wheel"
    else
        echo "    âœ— py.typed NOT found in wheel! Contents:"
        unzip -l /tmp/python-build-check/*.whl || echo "Failed to list wheel content"
        exit 1
    fi
    rm -rf /tmp/python-build-check
    
    echo "âœ… Python checks passed"
    cd ..
fi

echo ""
echo "ðŸŽ‰ All pre-commit checks passed!"
